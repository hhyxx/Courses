# **一、嵌入式SQL**

## **1. 嵌入式SQL的处理过程**

- 主语言

- - 嵌入式**SQL**是将**SQL**语句嵌入程序设计语言中，被嵌入的程序设计语言，如**C**、**C++**、**Java**，称为宿主语言，简称主语言。

- 处理过程

- - 预编译方法

- 为了区分**SQL**语句与主语言语句，所有**SQL**语句必须加前缀**EXEC SQL**，
- 主语言为**C**语言时，语句格式：
    - **EXEC SQL <SQL**语句**>;**

## **2. 嵌入式SQL语句与主语言之间的通信**

- 将**SQL**嵌入到高级语言中混合编程，程序中会含有两种不同计算模型的语句

- - **SQL**语句

    - - 描述性的面向集合的语句
        - 负责操纵数据库

    - 高级语言语句

    - - 过程性的面向记录的语句
        - 负责控制逻辑流程

    - 它们之间应该如何通信？

- 数据库工作单元与源程序工作单元之间的通信
    - 向主语言传递**SQL**语句的执行状态信息，使主语言能够据此控制程序流程，主要用**SQL**通信区实现
    - 主语言向**SQL**语句提供参数，主要用主变量实现
    - 将**SQL**语句查询数据库的结果交主语言处理，主要用主变量和游标实现

### （1）SQL通信区

- **SQLCA**： **SQL Communication Area**

- - **SQLCA**是一个数据结构

- **SQLCA**的用途

- - **SQL**语句执行后，系统反馈给应用程序信息

    - - 描述系统当前工作状态
        - 描述运行环境

    - 这些信息将送到**SQL**通信区中

    - 应用程序从**SQL**通信区中取出这些状态信息，据此决定接下来执行的语句

- **SQLCA**使用方法

- - 定义**SQLCA**

    - - 用**EXEC SQL INCLUDE SQLCA**定义

    - 使用**SQLCA**

    - - **SQLCA**中有一个存放每次执行**SQL**语句后返回代码的变量**SQLCODE**
        - 如果**SQLCODE**等于预定义的常量**SUCCESS**，则表示**SQL**语句成功，否则表示出错
        - 应用程序每执行完一条**SQL** 语句之后都应该测试一下**SQLCODE**的值，以了解该**SQL**语句执行情况并做相应处理

### （2）主变量

- 主变量

- - 嵌入式**SQL**语句中可以使用主语言的程序变量来输入或输出数据
    - 在**SQL**语句中使用的主语言程序变量简称为主变量

- 主变量的类型

- - 输入主变量

    - - 由应用程序对其赋值，**SQL**语句引用

    - 输出主变量

    - - 由**SQL**语句对其赋值或设置状态信息，返回给应用程序

- 指示变量

- - 是一个整型变量，用来**“**指示**”**所指主变量的值或条件

    - 一个主变量可以附带一个指示变量（**Indicator Variable**）

    - 指示变量的用途

    - - 指示输入主变量是否为空值
        - 检测输出变量是否为空值，值是否被截断

- 在**SQL**语句中使用主变量和指示变量的方法

- - 说明主变量和指示变量

- - **BEGIN DECLARE SECTION**
    - **...**
    - **...** （说明主变量和指示变量）
    - **...**
    - **END DECLARE SECTION**

- ❖在**SQL**语句中使用主变量和指示变量的方法（续）

- - 使用主变量

    - - 说明之后的主变量可以在**SQL**语句中任何一个能够使用表达式的地方出现
        - 为了与数据库对象名（表名、视图名、列名等）区别，**SQL**语句中的主变量名前要加冒号（**:**）作为标志

    - 使用指示变量

    - - 指示变量前也必须加冒号标志
        - 必须紧跟在所指主变量之后

- 在**SQL**语句之外（主语言语句中）使用主变量和指示变量的方法

- - 可以直接引用，不必加冒号

### （3）游标

- 游标

- - 游标是系统为用户开设的一个数据缓冲区，存放**SQL**语句的执行结果
    - 每个游标区都有一个名字
    - 用户可以用**SQL**语句逐一从游标中获取记录，并赋给主变量，交由主语言进一步处理

### （4）建立和关闭数据库连接

- 建立数据库连接 ：

    **EXEC SQL CONNECT TO target \[AS connection-name][USER user-name];** 

    - **target**是要连接的数据库服务器

    - - 常见的服务器标识串，如`<dbname>@<hostname>:<port> `
        - 包含服务器标识的**SQL**串常量 
        - **DEFAULT** 

- - **connect-name**是可选的连接名，连接名必须是一个有效的标识符 
    - 在整个程序内只有一个连接时可以不指定连接名
    - 程序运行过程中可以修改当前连接 

- - **EXEC SQL SET CONNECTION connection-name** **| DEFAULT;**

- 关闭数据库连接 ：**EXEC SQL DISCONNECT [connection];**

## **3. 不使用游标的SQL语句**

### **（1）** 查询结果为单记录的**SELECT**语句 

- 这类语句不需要使用游标，只需用**INTO**子句指定存放查询结果的主变量。 

**[**例**8.2]** 根据学生号码查询学生信息。

```sql
EXEC SQL SELECT Sno,Sname,Ssex,Sage,Sdept
	INTO:Hsno,:Hname,:Hsex,:Hage,:Hdept
	FROM Student
	WHERE Sno =: givensno;
/*把要查询的学生的学号赋给为了主变量givensno*/
```

- **INTO**子句、**WHERE**子句和**HAVING**短语的条件表达式中均可以使用主变量
- 查询返回的记录中，可能某些列为空值**NULL**
- 如果查询结果实际上并不是单条记录，而是多条记录，则程序出错，关系数据库管理系统会在**SQLCA**中返回错误信息 

**[**例**8.3]** 查询某个学生选修某门课程的成绩。假设已经把将要查询的学生的学号赋给了主变量**givensno**，将课程号赋给了主变量**givencno**。

```sql
EXEC SQL SELECT Sno,Cno,Grade
	INTO :Hsno,:Hcno,:Hgrade:Gradeid
	/* 指示变量**Gradeid*/
	FROM SC
	WHERE Sno=:givensno AND Cno=:givencno;

/* 如果 Gradeid < 0，不论Hgrade为何值，均认为该学生成绩为空值。*/
```



### **（2）**非**CURRENT**形式的增删改语句

- 在**UPDATE**的**SET**子句和**WHERE**子句中可以使用主变量，**SET**子句还可以使用指示变量 

**[**例**8.4]** 修改某个学生选修**1**号课程的成绩。

```sql
EXEC SQL UPDATE SC
	SET Grade=:newgrade 
	/* 修改的成绩已赋给主变量：newgrade */
	WHERE Sno=:givensno;

/* 学号赋给主变量：givensno */
```



**[**例**8.5]** 某个学生新选修了某门课程，将有关记录插入**SC**表中。假设插入的学号已赋给主变量**stdno**，课程号已赋给主变量**couno**。

```sql
gradeid=-1；              /* gradeid为指示变量，赋为负值 */

EXEC SQL INSERT
	INTO SC(Sno,Cno,Grade)
	VALUES(:stdno,:couno,:gr :gradeid);
/* 
	:stdno，:couno，:gr 为主变量
  由于该学生刚选修课程，成绩应为空，所以要把指示变量赋为负值
*/
```



## **4. 使用游标的SQL语句**

### （1）查询结果为多条记录的**SELECT**语句

- 使用游标的步骤

- - 说明游标
    - 打开游标
    - 推进游标指针并取当前记录 
    - 关闭游标

- 使用**DECLARE**语句
- 语句格式

**EXEC SQL DECLARE <**游标名**> CURSOR** **FOR <SELECT**语句**>;**

- 功能

- - 是一条说明性语句，这时关系数据库管理系统并不执行**SELECT**语句

### **（2）CURRENT**形式的**UPDATE**语句

### **（3）CURRENT**形式的**DELETE**语句

## 
